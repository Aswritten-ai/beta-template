name: sparql/validate

on:
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install validation dependencies
        run: npm install sparqljs n3 shacl-js glob

      - name: Find SPARQL files
        id: find-sparql
        run: |
          files=$(find .aswritten/tx -name "*.sparql" 2>/dev/null | head -100 || true)
          if [ -z "$files" ]; then
            echo "No SPARQL files found"
            echo "has_files=false" >> "$GITHUB_OUTPUT"
          else
            echo "Found SPARQL files:"
            echo "$files"
            echo "has_files=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate SPARQL syntax and structure
        if: steps.find-sparql.outputs.has_files == 'true'
        run: |
          node scripts/validate-sparql.js \
            --files ".aswritten/tx/**/*.sparql" \
            --shapes ".aswritten/shapes.ttl" \
            --format text

      - name: Validation Summary
        if: always()
        run: |
          if [ "${{ steps.find-sparql.outputs.has_files }}" = "false" ]; then
            echo "::notice::No SPARQL transaction files to validate"
          else
            echo "::notice::SPARQL validation completed"
          fi
